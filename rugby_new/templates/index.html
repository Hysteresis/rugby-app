<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Les clubs sportifs</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    {% load static %}
    <link rel="stylesheet" href="{% static 'style.css' %}">
</head>
<body>
{% include 'navbar.html' %}
<div class="container home">
    <div class="row row-cols-1 row-cols-md-2 my-2 my-md-4 g-4">
        <div class="col text-center text-white">
            <div class="card h-100">
              <div class="card-body card-custom">
                <button class="btn btn-success mt-2 mb-2" id="btn_showNumberOfLines" onclick="IncrementerCompteur()" type="button" >Calculer nombre de lignes</button>
                <h4 class="counterLg my-2 pt-2" id="value_count_ODS">...</h4>
              </div>
            </div>
        </div>
        <div class="col text-center text-white">
            <div class="card h-100"  id="bulk_card">
              <div class="card-body card-custom">
                <button class="btn btn-success mt-2 mb-2" id="btn_bulkDB"  onclick="runScript()" type="button" >Mise à jour BDD</button>
                <h4 class="counterLg my-2 pt-2" id="elapsed_time">...</h4>
              </div>
            </div>
        </div>
        <div class="col text-center text-white">
            <div class="card h-100">
              <div class="card-body card-custom">
                <button class="btn btn-success mt-2 mb-2" onclick="" type="button">lorem</button>
                <h4 class="counterLg my-2 pt-2">...</h4>
              </div>
            </div>
        </div>
        <div class="col text-center text-white">
            <div class="card h-100">
              <div class="card-body card-custom">
                <button class="btn btn-success mt-2 mb-2" onclick="" type="button">ipsum</button>
                <h4 class="counterLg my-2 pt-2">...</h4>
              </div>
            </div>
        </div>
    </div>
</div>

<script>
function runScript() {
    let xhr = new XMLHttpRequest();
    let startTime = new Date().getTime();
    let elapsed_time = document.querySelector('#elapsed_time')
    let bulk_card = document.querySelector('#bulk_card')
    bulk_card.style.backgroundImage = "";
    elapsed_time.innerText = '- Bulk -'
    let isHidden = false;
    let blinkInterval = setInterval(function() {
        if (isHidden) {
            elapsed_time.innerText = '- Bulk -';
        } else {
            elapsed_time.innerText = '...';
        }
        isHidden = !isHidden;
    }, 1000);
    xhr.open('GET', '/etl_ods', true);
    xhr.onreadystatechange = function() {

        if (xhr.readyState === 4 && xhr.status === 200) {
            clearInterval(blinkInterval);
            let endTime = new Date().getTime();
            let elapsedTime = (endTime - startTime) / 1000
            elapsed_time.innerText = " en " + elapsedTime.toFixed(1) + " s"
            bulk_card.style.backgroundImage = "url('https://pngimg.com/d/hulk_PNG7.png')";
            bulk_card.style.backgroundRepeat = "no-repeat";
            bulk_card.style.backgroundSize = "cover";
            bulk_card.style.backgroundPosition = "center top";
            bulk_card.style.color = "yellow"
        } else if (xhr.readyState === 4 && xhr.status !== 200) {
            clearInterval(blinkInterval);
            alert('Une erreur s\'est produite lors de l\'exécution du script.');
        }
    };
    xhr.send();
}

function showNumberOfLines() {
    document.getElementById('numberOfLines').classList.remove('d-none');
}

function IncrementerCompteur() {
console.log('Incrementer compteur')
    let delay = 1;
    let currentCount = 0;
    let value_count = document.querySelector("#value_count_ODS");

    function increment() {
        if (currentCount <= {{ nombre_lignes_ods }}) {
            value_count.innerText = currentCount;
            currentCount += Math.floor(Math.random() * 350);
            setTimeout(increment, delay);
        } else {
        value_count.innerText = {{ nombre_lignes_ods }};
        }
    }
    increment();
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
</body>
</html>